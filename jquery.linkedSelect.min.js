/*
 *
 * jQuery Linked Selects Plugin
 * 2016-01-09
 *
 * Copyright 2016 Bogac Bokeer me@bokeer.net
 * Licensed under the MIT license
 *
 */
!(function(a,b){'use strict';if(typeof define==='function'&&define.amd){define(['jquery'],b)}else if(typeof exports==='object'){module.exports=b(require('jquery'))}else{b(a.jQuery)}}(this,function($){'use strict';var h=(function(){var e=function(a,b,c){if(!a||typeof a!=='string'){return null}b=b||null;c=c||window;a=a.split('.');var d=false,prop,subns;while(a.length>1&&(typeof c==='object')){subns=a.shift();prop=a;c=c[subns]}if(typeof c==='object'){a=a.shift();prop=a;a=c[a];d=b?typeof a===b:typeof a!=='undefined'}e.lastKey=d?{o:c,prop:prop}:null;e.lastValue=d?a:null;return d};e.lastKey=null;e.lastValue=null;e.setLastKey=function(a){var b,prop,r;if(e.lastKey&&(b=e.lastKey.o)&&(prop=e.lastKey.prop)){r=b[prop]=a}return r};return e}()),isInteger=function(a){return Number(a)===a&&a%1===0},isFloat=function(a){return a===+a&&a!==(a|0)},isString=function(a){return $.type(a)==='string'};$.linkedSelect={options:{attrTarget:'data-select-target',attrService:'data-select-service',attrFilter:'data-select-service-asfilter',method:'POST',onBeforeFill:function(a,b,c){},onAfterFill:function(a,b,c){}},extension:{service:{_default:'ajax',variable:function(a,b){if(!h(a)){return false}var p=$.Deferred();p.resolve({result:true,items:h.lastValue});return p},ajax:function(a,b){a=a.split('|');var c=a[0].trim()||location.href,serviceMethod=a[1]||'POST';return $.ajax({url:c,type:serviceMethod,dataType:'json',data:b})}},filter:{_default:'all',filter1:function(c){var d=$.linkedSelect,filterFn=false;if(/^[0-9a-z_]+$/i.test(c)){filterFn=function(a,b){return a[c]===this.value||d.castData(this.value)===d.castData(a[c])}}return filterFn},expressions:function(a){return new Function('item','index','return '+a)},all:function(a){return function(){return true}}}},getExtension:function(a,b){b=b||null;var c=this,extensions=c.extension[a],extData=null,ext,fn;for(ext in extensions){if(extensions.hasOwnProperty(ext)&&ext!==extensions._default){if($.isFunction(fn=extensions[ext])&&(extData=fn.apply(c,b))){return extData}}}return extensions[extensions._default].apply(c,b)||extData},addOption:function(a,b,c,d){c=c||'';d=d||false;var e=document.createElement('option');e.text=b;e.value=c;if(!!d){e.selected=true}a.appendChild(e);return e},castData:function(a){if(typeof a==='undefined'){return undefined}if(isString(a)){if(a.toLowerCase()==='true'){return true}if(a.toLowerCase()==='false'){return false}}if(isFloat(a)){return parseFloat(a)}if(isInteger(a)){return parseInt(a,10)}return a},emptySelect:function(a,b,c){if(!a||!a.length){return a}var d=this;b=b||false;c=c||false;var e=b?0:1;if(a.find('option').length<=e){return a}while(a.find('option').length>e){a.find('option').eq(1).off().remove()}if($.isPlainObject(b)){this.addOption(a[0],b.text,b.value)}d.settings&&$.isFunction(d.settings.onAfterFill)&&d.settings.onAfterFill.call(null,a);if(c&&a&&a.length){d.emptySelect(d.getSelectInfo(a).$target,false,c)}return a},fillData:function(a,b,c){var d=this,options=d.settings;options&&$.isFunction(options.onBeforeFill)&&options.onBeforeFill.call(null,a,b,c);d.emptySelect(b,false);if(a){c&&$.each(c,function(){d.addOption(b[0],this.text,this.value,this.selected)});options&&$.isFunction(options.onAfterFill)&&options.onAfterFill.call(null,b,a,c)}d.emptySelect(d.getSelectInfo(b).$target,false,true)},getData:function(a,b,c,d){var e=this;c=c||false;if(!c){return a}var f=a,filterFn=e.getFilter(b,c,d);if(filterFn){f=f.filter(filterFn)}return f},getFilter:function(a,b,c){var d=this,filterData=d.getExtension('filter',[b]);if(!!filterData){filterData.value=d.castData(a);filterData.filter=b;filterData.extraData=c||null;filterData=$.proxy(filterData,filterData)}return filterData},getSelectInfo:function(a){if(!a){return null}var b={targetName:a.attr(this.settings.attrTarget),service:a.attr(this.settings.attrService)?a.attr(this.settings.attrService):false,value:a.val(),$target:null};b.$target=$('select[name='+b.targetName+']');return b},getServiceData:function(a,b){return this.getExtension('service',[a,b])},reset:function(a){var b=this,targets={},targetName;a.each(function(){targetName=b.getSelectInfo($(this)).targetName;targets[targetName]=$('select[name='+targetName+']')});$.each(targets,function(){b.emptySelect($(this),false)});targets=null},isExists:h,isInteger:isInteger,isFloat:isFloat,isString:isString,init:function(a){var b=$.linkedSelect;b.settings=$.extend({},b.options,a);$('['+b.settings.attrTarget+']').linkedSelect()}};$.fn.linkedSelect=function(){var g='bbLinkedSelect',base=$.linkedSelect,options=base.settings;base.reset(this);return this.not(g+'-init').each(function(){$(this).on('change',function(e){var c=$(this),selectInfo=base.getSelectInfo(c),filter=c.attr(options.attrFilter)||false,value=selectInfo.value;if(!filter||filter.trim()===''){filter=false}var d={source:this,target:selectInfo.$target,service:selectInfo.service};if(filter&&c.data(g+'_filter')){var f=base.getData(c.data(g+'_filter'),value,filter,d);base.fillData(c,selectInfo.$target,f)}else{base.getServiceData(selectInfo.service,{field:c.attr('name'),target:selectInfo.targetName,value:value},options.method).done(function(a){if(a.result){var b=a.items;if(filter){c.data(g+'_filter',b);b=base.getData(b,value,filter,d)}base.fillData(c,selectInfo.$target,b)}})}}).addClass(g+'-init')})}}));